<!doctype html>
<html lang="vi">

<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gi·ªè h√†ng - SHOPPY</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Inter, system-ui, "Segoe UI", Roboto, Arial;
      line-height: 1.4;
      color: #222;
      background: #f0f2f5;
      padding-bottom: 100px;
      animation: pageFadeIn 0.5s ease-in-out;
    }

    /* --- Header --- */
    .cart-page-header {
      background: #005FFF;
      padding: 20px 40px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: #fff;
    }
    .logo-container a { display: flex; align-items: center; gap: 8px; text-decoration: none; color: inherit; }
    .header-logo { height: 36px; width: auto; }
    .cart-page-header h1 { font-size: 28px; font-weight: 700; }
    .cart-page-header span {
      font-size: 24px; font-weight: 700; border-left: 1px solid #fff;
      padding-left: 12px; margin-top: 4px;
    }
    .back-link { margin-left: auto; text-decoration: none; color: #fff; font-weight: 500; }
    .back-link:hover { color: #ddd; text-decoration: underline; }

    /* --- Main Content --- */
    main { width: 100%; max-width: 1200px; margin: 20px auto; padding: 0 20px; }

    .cart-header-row {
      display: flex; background: #fff; padding: 15px 20px;
      border-radius: 6px; font-weight: 500; color: #555; margin-bottom: 12px;
    }
    .col-product { flex: 4; }
    .col-price { flex: 2; text-align: center; }
    .col-qty { flex: 2; text-align: center; }
    .col-total { flex: 2; text-align: center; }
    .col-action { flex: 1; text-align: right; }

    /* Item Styles */
    .cart-page-item {
      display: flex; align-items: center; background: #fff;
      padding: 20px; border-radius: 6px; margin-bottom: 12px;
    }
    .cart-page-item .col-product { display: flex; align-items: center; gap: 12px; }
    .cart-page-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 6px; border: 1px solid #eee; }
    .product-info h4 { font-size: 16px; margin-bottom: 4px; }
    .product-info .shop-info { font-size: 13px; color: #777; margin-bottom: 4px; }
    .product-info .rating-info { font-size: 13px; color: #222; }
    .rating-info .stars { color: #f59e0b; letter-spacing: -1px; }

    /* Qty Buttons */
    .qty-selector { display: flex; justify-content: center; align-items: center; gap: 6px; }
    .qty-btn { padding: 6px 10px; border-radius: 4px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    .qty-btn:hover { background: #f9f9f9; }
    .qty-display { min-width: 30px; text-align: center; font-size: 15px; }

    .delete-btn { color: #00aaff; text-decoration: none; font-weight: 500; cursor: pointer; }
    .delete-btn:hover { text-decoration: underline; }

    /* Checkout Bar */
    .checkout-bar {
      position: fixed; bottom: 0; left: 0; width: 100%; background: #fff;
      padding: 20px 40px; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      display: flex; justify-content: flex-end; align-items: center; gap: 20px;
    }
    .total-text { font-size: 18px; }
    .total-text span { font-size: 22px; font-weight: 700; color: #00aaff; }
    .checkout-page-btn {
      background: #00aaff; color: white; border: none; padding: 12px 30px;
      font-size: 16px; font-weight: 500; border-radius: 4px; cursor: pointer;
    }
    .checkout-page-btn:hover { background: #0c40cf; }
    .empty-cart { text-align: center; padding: 50px; font-size: 20px; color: #777; }

    /* Animations */
    @keyframes pageFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    body.page-fade-out { animation: pageFadeOut 0.5s ease-in-out forwards; }
    @keyframes pageFadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-10px); } }
  </style>
</head>

<body>

  <header class="cart-page-header">
    <div class="logo-container">
      <a href="index.html"> <img src="images/logo/logo1.png" alt="SHOPPY Logo" class="header-logo">
        <h1>SHOPPY</h1>
      </a>
    </div>
    <span>Gi·ªè h√†ng</span>
    <a href="index.html" class="back-link">‚ùÆ Tr·ªü l·∫°i mua s·∫Øm</a> </header>

  <main>
    <div class="cart-header-row">
      <div class="col-product">S·∫£n Ph·∫©m</div>
      <div class="col-price">ƒê∆°n Gi√°</div>
      <div class="col-qty">S·ªë L∆∞·ª£ng</div>
      <div class="col-total">S·ªë Ti·ªÅn</div>
      <div class="col-action">Thao T√°c</div>
    </div>

    <div id="cart-page-list">
      <div style="text-align: center; padding: 40px; color: #666;">ƒêang t·∫£i d·ªØ li·ªáu gi·ªè h√†ng...</div>
    </div>
  </main>

  <div class="checkout-bar">
    <div class="total-text" id="cart-page-total">
      T·ªïng c·ªông (0 S·∫£n ph·∫©m): <span>0‚Ç´</span>
    </div>
    <button class="checkout-page-btn" id="cart-page-checkout">Mua ngay</button>
  </div>


  <script>
    // ---
    // JavaScript cho trang cart.html (ƒê√£ t·ªëi ∆∞u h√≥a API)
    // ---

    let CART_DATA = {}; // Ch·ª©a d·ªØ li·ªáu chi ti·∫øt t·ª´ API /api/cart/details
    let cart = JSON.parse(localStorage.getItem('cart_v1') || '{}');
    const $ = sel => document.querySelector(sel);

    function formatMoney(n) {
      return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + '‚Ç´';
    }

    // 1. H√†m t·∫£i d·ªØ li·ªáu chi ti·∫øt gi·ªè h√†ng (G·ªçi API Cart Details)
    async function loadCartData() {
      const cartKeys = Object.keys(cart);
      
      // N·∫øu gi·ªè r·ªóng th√¨ render lu√¥n (tr·ªëng)
      if (cartKeys.length === 0) {
          renderCartPage();
          return;
      }

      try {
        const res = await fetch('/api/cart/details', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cart: cart })
        });
        
        if (res.ok) {
            CART_DATA = await res.json();
            renderCartPage();
        } else {
            console.error("L·ªói API:", res.status);
            $('#cart-page-list').innerHTML = '<p style="color:red; text-align:center; padding:20px">L·ªói khi t·∫£i th√¥ng tin gi·ªè h√†ng.</p>';
        }
      } catch (err) {
        console.error("L·ªói k·∫øt n·ªëi:", err);
        $('#cart-page-list').innerHTML = '<p style="color:red; text-align:center; padding:20px">Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.</p>';
      }
    }

    function saveCart() {
      localStorage.setItem('cart_v1', JSON.stringify(cart));
      renderCartPage();
    }

    function changeQty(key, delta) {
      cart[key] = (cart[key] || 0) + delta;
      if (cart[key] <= 0) delete cart[key];
      saveCart();
    }

    function removeItem(key) {
      if(confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')){
         delete cart[key];
         saveCart();
      }
    }

    // 2. H√†m Render Gi·ªè h√†ng (D√πng d·ªØ li·ªáu t·ª´ CART_DATA)
    function renderCartPage() {
      const cartList = $('#cart-page-list');
      const cartCount = Object.values(cart).reduce((s, q) => s + q, 0);
      let total = 0;

      if (cartCount === 0) {
        cartList.innerHTML = '<div class="empty-cart">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng <br><br> <a href="index.html" style="font-size:16px; color:#005FFF">ƒêi mua s·∫Øm ngay</a></div>';
        $('#cart-page-total').innerHTML = `T·ªïng c·ªông (0 S·∫£n ph·∫©m): <span>0‚Ç´</span>`;
        return;
      }

      cartList.innerHTML = '';

      // Duy·ªát qua t·ª´ng item trong LocalStorage
      Object.entries(cart).forEach(([key, qty]) => {
        // L·∫•y th√¥ng tin chi ti·∫øt t·ª´ CART_DATA ƒë√£ fetch
        const itemDetails = CART_DATA[key];

        if (!itemDetails) {
            // Tr∆∞·ªùng h·ª£p c√≥ trong localStorage nh∆∞ng API kh√¥ng tr·∫£ v·ªÅ (l·ªói ho·∫∑c sp b·ªã x√≥a)
            // C√≥ th·ªÉ ch·ªçn ·∫©n ƒëi ho·∫∑c hi·ªÉn th·ªã loading
            return;
        }

        // L·∫•y th√¥ng tin c·ª≠a h√†ng (API tr·∫£ v·ªÅ m·∫£ng stores v·ªõi 1 ph·∫ßn t·ª≠)
        const storeInfo = itemDetails.stores[0];
        
        // Gi√° ∆∞u ti√™n l·∫•y t·ª´ store
        const price = storeInfo.ps_min_price_store || 0;
        const itemTotal = price * qty;
        total += itemTotal;

        // X·ª≠ l√Ω ·∫£nh (∆Øu ti√™n ·∫£nh c·ª≠a h√†ng, fallback ·∫£nh s·∫£n ph·∫©m g·ªëc)
        let displayImage = itemDetails.product_image_url;
        if (storeInfo.product_images && storeInfo.product_images.length > 0) {
            displayImage = storeInfo.product_images[0].ps_image_url;
        }

        const item = document.createElement('div');
        item.className = 'cart-page-item';

        item.innerHTML = `
          <div class="col-product">
            <input type="checkbox" checked style="margin-right: 10px;" />
            <img src="${displayImage}" alt="${itemDetails.product_name}" onerror="this.src='images/placeholder.jpg'" />
            <div class="product-info">
              <h4>${itemDetails.product_name}</h4>
              <div class="shop-info">üè™ ${storeInfo.store_name}</div>
              <div class="shop-info" style="font-size:12px; color:#888">üìç ${storeInfo.store_address}</div>
            </div>
          </div>
          <div class="col-price" style="text-align:center;">${formatMoney(price)}</div>
          <div class="col-qty">
            <div class="qty-selector">
              <button class="qty-btn" onclick="changeQty('${key}', -1)">-</button>
              <div class="qty-display">${qty}</div>
              <button class="qty-btn" onclick="changeQty('${key}', 1)">+</button>
            </div>
          </div>
          <div class="col-total" style="text-align:center; font-weight: 500;">${formatMoney(itemTotal)}</div>
          <div class="col-action" style="text-align: right;">
            <a class="delete-btn" onclick="removeItem('${key}')">X√≥a</a>
          </div>
        `;

        cartList.appendChild(item);
      });

      $('#cart-page-total').innerHTML = `T·ªïng c·ªông (${cartCount} S·∫£n ph·∫©m): <span>${formatMoney(total)}</span>`;
    }

    // N√∫t "Mua ngay"
    $('#cart-page-checkout').addEventListener('click', () => {
      const count = Object.values(cart).reduce((s, q) => s + q, 0);
      if (count === 0) { alert('Gi·ªè h√†ng ƒëang r·ªóng.'); return; }
      
      // T√≠nh l·∫°i t·ªïng ti·ªÅn ƒë·ªÉ hi·ªÉn th·ªã trong confirm
      let finalTotal = 0;
      Object.entries(cart).forEach(([key, qty]) => {
          const itemDetails = CART_DATA[key];
          if(itemDetails) {
             const storeInfo = itemDetails.stores[0];
             finalTotal += (storeInfo.ps_min_price_store || 0) * qty;
          }
      });

      if (confirm(`X√°c nh·∫≠n thanh to√°n ${formatMoney(finalTotal)} ?`)) {
        alert('Thanh to√°n th√†nh c√¥ng ‚Äî c·∫£m ∆°n b·∫°n!');
        cart = {};
        saveCart();
        // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß sau khi mua
        window.location.href = 'index.html';
      }
    });

    // Kh·ªüi ch·∫°y khi t·∫£i trang
    window.onload = function() {
        loadCartData();
    };

  </script>
</body>

</html>